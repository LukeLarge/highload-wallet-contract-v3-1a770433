name: Manual Security Scan

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  quick-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Run quick pattern scans
        run: |
          set -euo pipefail
          out_dir="$GITHUB_WORKSPACE/security-scan-output"
          mkdir -p "$out_dir"
          echo "Scanning repo for suspicious patterns..." > "$out_dir/report.txt"
          echo "" >> "$out_dir/report.txt"
          # Suspicious CI downloads
          { grep -RIn --exclude-dir=.git -e "curl -fsSL" -e "wget -qO" -e "sh -" || true; } >> "$out_dir/report.txt"
          # Dynamic exec/eval usage
          { grep -RIn --exclude-dir=.git -e "eval(" -e "exec(" -e "popen(" -e "system(" || true; } >> "$out_dir/report.txt"
          # Base64/obfuscation patterns
          { grep -RIn --exclude-dir=.git -E "base64_decode|fromCharCode|atob|btoa|\\x[0-9a-fA-F]{2,}" || true; } >> "$out_dir/report.txt"
          # Recent commits (30 days)
          git --no-pager log --since="30 days ago" --pretty=format:"%h %ad %an %s" --date=iso | head -n 200 > "$out_dir/recent-commits.txt" || true
          echo "Scan complete. Attach these artifacts for triage." >> "$out_dir/report.txt"
          ls -la "$out_dir" >> "$out_dir/report.txt"
          cat "$out_dir/report.txt"
      - name: Upload scan artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: security-scan-output
          path: security-scan-output
